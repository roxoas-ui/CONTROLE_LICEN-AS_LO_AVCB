{% extends "base.html" %}

{% block title %}AVCB{% endblock %}

{% block content %}
<div class="space-y-8">
    <section class="grid gap-4 md:grid-cols-4">
        <article class="surface rounded-xl p-4">
            <p class="text-xs uppercase text-slate-500">Total</p>
            <p class="mt-2 text-2xl font-semibold">{{ avcb_metrics.total }}</p>
        </article>
        <article class="surface rounded-xl p-4">
            <p class="text-xs uppercase text-slate-500">Válidos</p>
            <p class="mt-2 text-2xl font-semibold">{{ avcb_metrics.valid }}</p>
        </article>
        <article class="surface rounded-xl p-4">
            <p class="text-xs uppercase text-slate-500">Expirados</p>
            <p class="mt-2 text-2xl font-semibold text-amber-400">{{ avcb_metrics.expired }}</p>
        </article>
        <article class="surface rounded-xl p-4">
            <p class="text-xs uppercase text-slate-500">Vencendo (30 dias)</p>
            <p class="mt-2 text-2xl font-semibold">{{ avcb_metrics.due_30 }}</p>
        </article>
    </section>

    <section class="surface rounded-2xl border border-muted">
        <div class="border-b border-muted px-6 pt-6">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                    <h2 class="text-xl font-semibold">Gestão de AVCB</h2>
                    <p class="text-sm text-slate-500">{{ avcbs_count }} registro{{ 's' if avcbs_count != 1 else '' }} carregado{{ 's' if avcbs_count != 1 else '' }}</p>
                </div>
                <button type="button" data-open-tab="form" class="btn-primary inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium shadow">
                    Novo AVCB
                </button>
            </div>
            <div class="mt-6 flex gap-2">
                <button type="button" data-tab-target="list" class="tab-trigger rounded-t-lg px-4 py-2 text-sm font-medium">
                    Painel
                </button>
                <button type="button" data-tab-target="form" class="tab-trigger rounded-t-lg px-4 py-2 text-sm font-medium">
                    Cadastro
                </button>
            </div>
        </div>
        <div class="px-6 pb-6" data-tabs data-default-tab="{{ active_tab }}">
            {% if message %}
            <div class="mt-6 rounded-lg border border-emerald-500/70 bg-emerald-600/10 px-4 py-3 text-sm text-emerald-200">
                {{ message }}
            </div>
            {% elif error %}
            <div class="mt-6 rounded-lg border border-rose-500/70 bg-rose-600/10 px-4 py-3 text-sm text-rose-200">
                {{ error }}
            </div>
            {% endif %}
            <div class="mt-6 space-y-10">
                <div data-tab-panel="list">
                    <form method="get" action="/ui/avcbs" class="mb-6 grid gap-4 rounded-xl border border-muted bg-transparent p-4 md:grid-cols-4">
                        <input type="hidden" name="tab" value="list">
                        <label class="text-sm text-slate-400">
                            Status
                            <select name="status" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                                <option value="">Todos</option>
                                {% for value, label in avcb_status_options %}
                                <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="text-sm text-slate-400">
                            Vencimento em até
                            <select name="due_within" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                                <option value="">Sem filtro</option>
                                {% for option in due_within_options %}
                                <option value="{{ option }}" {% if selected_due_within == option %}selected{% endif %}>{{ option }} dias</option>
                                {% endfor %}
                            </select>
                        </label>
                        <div class="flex items-end gap-3 md:col-span-2">
                            <button type="submit" class="btn-primary inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium shadow">
                                Aplicar filtros
                            </button>
                            <a href="/ui/avcbs" class="btn-outline inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium">
                                Limpar
                            </a>
                        </div>
                    </form>
                    <div class="overflow-x-auto rounded-xl border border-muted">
                        <table class="min-w-full divide-y divide-slate-700 text-sm">
                            <thead class="bg-slate-900/40 text-slate-300 uppercase">
                                <tr>
                                    <th class="px-4 py-3 text-left">Imóvel</th>
                                    <th class="px-4 py-3 text-left">Responsável técnico</th>
                                    <th class="px-4 py-3 text-left">Emissão</th>
                                    <th class="px-4 py-3 text-left">Validade</th>
                                    <th class="px-4 py-3 text-left">Status</th>
                                    <th class="px-4 py-3 text-left">Notas</th>
                                    <th class="px-4 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800">
                                {% for avcb in avcbs %}
                                <tr class="hover:bg-emerald-600/10">
                                    <td class="px-4 py-3 font-medium">{{ avcb.property_name }}</td>
                                    <td class="px-4 py-3">{{ avcb.technical_responsible or '-' }}</td>
                                    <td class="px-4 py-3">{{ avcb.issue_date or '-' }}</td>
                                    <td class="px-4 py-3">{{ avcb.expiry_date }}</td>
                                    <td class="px-4 py-3">
                                        <span class="inline-flex items-center rounded-full border border-emerald-500/40 px-2 py-0.5 text-xs uppercase tracking-wide text-emerald-200">
                                            {{ avcb.status.name.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-slate-400">{{ avcb.notes or '-' }}</td>
                                    <td class="px-4 py-3">
                                        <div class="flex justify-end gap-2">
                                            <a href="{{ request.url_for('list_avcbs') }}?edit_avcb={{ avcb.id }}&tab=form" class="btn-outline inline-flex items-center rounded-lg px-3 py-1 text-xs font-semibold uppercase tracking-wide">
                                                Editar
                                            </a>
                                            <form action="/ui/avcbs/{{ avcb.id }}/delete" method="post" data-confirm="Remover este AVCB?">
                                                <button type="submit" class="inline-flex items-center rounded-lg border border-rose-500 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-rose-300">
                                                    Excluir
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="px-4 py-6 text-center text-slate-500">Nenhum AVCB cadastrado.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="hidden" data-tab-panel="form">
                    <form action="/ui/avcbs" method="post" class="grid gap-4">
                        {% if edit_avcb %}
                        <input type="hidden" name="avcb_id" value="{{ edit_avcb.id }}">
                        <div class="flex items-center justify-between rounded-lg border border-amber-500/70 bg-amber-500/10 px-4 py-3 text-sm text-amber-200">
                            <span>Editando <strong>{{ edit_avcb.property_name }}</strong></span>
                            <a href="{{ request.url_for('list_avcbs') }}?tab=form" class="hover:underline">Cancelar edição</a>
                        </div>
                        {% endif %}
                        <div class="grid gap-4 md:grid-cols-2">
                            <label class="text-sm text-slate-400 md:col-span-2">
                                Imóvel
                                <input name="property_name" type="text" required value="{{ edit_avcb.property_name if edit_avcb else '' }}" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                            </label>
                            <label class="text-sm text-slate-400 md:col-span-2">
                                Endereço
                                <textarea name="property_address" rows="2" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">{{ edit_avcb.property_address if edit_avcb else '' }}</textarea>
                            </label>
                            <label class="text-sm text-slate-400">
                                Responsável técnico
                                <input name="technical_responsible" type="text" value="{{ edit_avcb.technical_responsible if edit_avcb else '' }}" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                            </label>
                            <label class="text-sm text-slate-400">
                                Data de emissão
                                <input name="issue_date" type="date" value="{{ edit_avcb.issue_date if edit_avcb else '' }}" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                            </label>
                            <label class="text-sm text-slate-400">
                                Data de validade
                                <input name="expiry_date" type="date" required value="{{ edit_avcb.expiry_date if edit_avcb else '' }}" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                            </label>
                            <label class="text-sm text-slate-400">
                                Status
                                {% set selected_form_status = edit_avcb.status.value if edit_avcb else default_avcb_status %}
                                <select name="status" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">
                                    {% for value, label in avcb_status_options %}
                                    <option value="{{ value }}" {% if selected_form_status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </label>
                            <label class="text-sm text-slate-400 md:col-span-2">
                                Observações
                                <textarea name="notes" rows="3" class="mt-1 w-full rounded-lg border border-muted bg-transparent px-3 py-2 text-sm">{{ edit_avcb.notes if edit_avcb else '' }}</textarea>
                            </label>
                        </div>
                        <div class="flex justify-end gap-3 pt-2">
                            <a href="{{ request.url_for('list_avcbs') }}" class="btn-outline inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium">
                                Voltar para lista
                            </a>
                            <button type="submit" class="btn-primary inline-flex items-center rounded-lg px-4 py-2 text-sm font-medium shadow">
                                {{ 'Atualizar AVCB' if edit_avcb else 'Registrar AVCB' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll('[data-tabs]').forEach((container) => {
        const defaultTab = container.dataset.defaultTab || 'list';
        const section = container.closest('section');
        const triggers = section.querySelectorAll('[data-tab-target]');
        const quickActions = section.querySelectorAll('[data-open-tab]');
        const panels = container.querySelectorAll('[data-tab-panel]');

        const setActive = (tab) => {
            panels.forEach((panel) => {
                panel.classList.toggle('hidden', panel.dataset.tabPanel !== tab);
            });
            triggers.forEach((trigger) => {
                const isActive = trigger.dataset.tabTarget === tab;
                trigger.classList.toggle('btn-primary', isActive);
                trigger.classList.toggle('text-slate-400', !isActive);
            });
        };

        triggers.forEach((trigger) => {
            trigger.addEventListener('click', () => setActive(trigger.dataset.tabTarget));
        });
        quickActions.forEach((button) => {
            button.addEventListener('click', () => setActive(button.dataset.openTab));
        });

        setActive(defaultTab);
    });

    document.querySelectorAll('form[data-confirm]').forEach((form) => {
        form.addEventListener('submit', (event) => {
            const message = form.dataset.confirm || 'Confirmar ação?';
            if (!confirm(message)) {
                event.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}
